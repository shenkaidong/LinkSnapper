# LinkSnapper 业务逻辑文档

## 1. 核心功能

### 1.1 截图模式
LinkSnapper 提供三种截图模式：
1. **普通截图**：单次截取当前视口内容
2. **分段截图**：按视口高度分段截取，支持继续截取下一页
3. **全页面截图**：一次性截取整个网页内容

### 1.2 网站类型适配
系统会自动识别三种类型的网站：
1. **动态网站**（如B站、知乎等）：需要处理动态加载内容
2. **单页应用**（SPA）：需要处理前端路由和动态数据
3. **静态网站**：基础的HTML页面

## 2. 业务流程

### 2.1 普通截图流程
1. 用户输入URL
2. 系统打开无头浏览器访问页面
3. 等待页面加载完成
4. 截取当前视口内容
5. 返回截图结果

### 2.2 分段截图流程
1. 用户输入URL
2. 系统打开无头浏览器访问页面
3. 检测网站类型（动态/SPA/静态）
4. 等待页面加载完成
5. 记录当前滚动位置（使用globalScrollPositions存储）
6. 截取当前视口内容
7. 用户点击"继续截图下一页"：
   - 计算新的滚动位置（lastPosition + viewportHeight）
   - 滚动到新位置
   - 等待内容加载（动态网站需要特殊处理）
   - 截取新位置的内容
8. 重复步骤7直到到达页面底部

### 2.3 全页面截图流程
1. 用户输入URL并选择全页面截图
2. 系统打开无头浏览器访问页面
3. 检测网站类型
4. 对于动态网站和SPA：
   - 执行预加载滚动
   - 等待动态内容加载完成
5. 使用puppeteer的fullPage选项截取整个页面
6. 返回完整截图

## 3. 关键技术点

### 3.1 滚动位置管理
- 使用全局对象globalScrollPositions记录每个URL的滚动位置
- 分段截图时通过lastPosition跟踪上次位置
- 新的滚动位置 = 上次位置 + 视口高度

### 3.2 动态内容处理
- 使用waitForDynamicContent等待动态加载
- 检测加载指示器消失
- 监控页面高度变化
- 处理无限滚动加载

### 3.3 截图优化
- 使用optimizeForSpeed提高截图性能
- 设置合适的视口大小（1920x1080）
- 针对不同类型网站使用不同的等待策略

### 3.4 错误处理
- 自动重试机制（最多3次）
- 超时处理（30秒超时限制）
- 优雅降级（如果动态加载失败，仍返回可用内容）

## 4. 存在的问题

### 4.1 当前已知问题
1. 分段截图时，继续截取下一页可能会回到顶部
2. 某些动态网站可能未正确触发内容加载
3. 全页面截图可能会遗漏动态加载的内容

### 4.2 待优化点
1. 改进滚动位置计算逻辑
2. 增强动态内容检测机制
3. 优化截图拼接的平滑度
4. 添加更多网站类型的特殊处理 